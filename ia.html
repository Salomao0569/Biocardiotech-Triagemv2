<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central IA - Biocardio</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #003d7a 0%, #002850 100%);
            padding: 25px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .logo {
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            font-weight: 800;
        }
        .clinica { color: #fff; }
        .biocardio { color: #c8102e; }
        .btn-nav {
            padding: 10px 20px;
            border: 2px solid white;
            background: transparent;
            color: white;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }
        .btn-nav:hover {
            background: white;
            color: #003d7a;
        }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .page-title {
            font-family: 'Montserrat', sans-serif;
            color: #60a5fa;
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 10px;
            text-align: center;
        }
        .page-subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #60a5fa;
            font-size: 18px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .oracle-section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .oracle-title {
            color: #60a5fa;
            font-family: 'Montserrat', sans-serif;
            font-size: 22px;
            margin-bottom: 8px;
        }
        .oracle-subtitle {
            color: #94a3b8;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .oracle-chat {
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chat-messages {
            min-height: 250px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
        }
        .chat-welcome {
            text-align: center;
            padding: 30px;
        }
        .welcome-icon {
            font-size: 50px;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .chat-welcome h3 {
            color: #60a5fa;
            font-size: 20px;
            margin-bottom: 10px;
        }
        .chat-welcome p {
            color: #94a3b8;
            margin-bottom: 15px;
        }
        .example-questions {
            list-style: none;
            text-align: left;
            max-width: 500px;
            margin: 0 auto;
        }
        .example-questions li {
            background: rgba(96, 165, 250, 0.1);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            color: #cbd5e1;
            border-left: 3px solid #60a5fa;
            font-size: 13px;
        }
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            gap: 12px;
        }
        .chat-message.user { flex-direction: row-reverse; }
        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .chat-avatar.user { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .chat-avatar.ai { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 10px;
        }
        .chat-bubble.user {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        .chat-bubble.ai {
            background: rgba(255,255,255,0.05);
            color: #e2e8f0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chat-input:focus {
            outline: none;
            border-color: #60a5fa;
        }
        .btn-send {
            padding: 12px 25px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .insight-card {
            background: rgba(255,255,255,0.05);
            border-radius: 14px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .insight-card-eco { border-left: 4px solid #10b981; }
        .insight-card-multi { border-left: 4px solid #8b5cf6; }
        .insight-card-risco { border-left: 4px solid #ef4444; }
        .insight-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .insight-card-icon { font-size: 28px; }
        .insight-card-header h3 {
            color: #e2e8f0;
            font-size: 16px;
        }
        .insight-card-body {
            color: #cbd5e1;
            font-size: 14px;
        }
        .diamond-section {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.1));
            border-radius: 14px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        .diamond-title {
            color: #c084fc;
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            margin-bottom: 8px;
        }
        .diamond-subtitle {
            color: #cbd5e1;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .diamond-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        .diamond-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        .diamond-item-name {
            color: white;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .diamond-item-stats {
            color: #cbd5e1;
            font-size: 13px;
        }
        .delta-section {
            background: rgba(255,255,255,0.05);
            border-radius: 14px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .delta-title {
            color: #60a5fa;
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            margin-bottom: 8px;
        }
        .delta-subtitle {
            color: #cbd5e1;
            margin-bottom: 15px;
            font-size: 14px;
        }
        #chart-container {
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 10px;
            min-height: 300px;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-content">
        <div class="logo">
            <span class="clinica">CL√çNICA</span> <span class="biocardio">Biocardio</span>
        </div>
        <div>
            <a href="index.html" class="btn-nav">üìã Triagem</a>
            <a href="dashboard.html" class="btn-nav">üìä Dashboard</a>
        </div>
    </div>
</div>

<div class="container">
    <h1 class="page-title">üß† Biocardio Intelligence Hub</h1>
    <p class="page-subtitle">Gest√£o Estrat√©gica e Cl√≠nica de Precis√£o</p>
    
    <div id="loading" class="loading">üîÆ Carregando Central de Intelig√™ncia...</div>
    
    <div id="content" style="display: none;">
        
        <div class="oracle-section">
            <h2 class="oracle-title">üí¨ Oracle IA</h2>
            <p class="oracle-subtitle">Fa√ßa perguntas sobre seus dados</p>
            <div class="oracle-chat">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-welcome">
                        <div class="welcome-icon">üîÆ</div>
                        <h3>Central de Intelig√™ncia Biocardio</h3>
                        <p>Pergunte sobre seus pacientes:</p>
                        <ul class="example-questions">
                            <li>"Quem s√£o os hipertensos sem Eco h√° 6 meses?"</li>
                            <li>"M√©dia de PA dos pacientes de Cardiologia?"</li>
                            <li>"Quais pacientes precisam de retorno?"</li>
                        </ul>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Digite sua pergunta..." class="chat-input">
                    <button onclick="enviarPergunta()" class="btn-send">üöÄ Enviar</button>
                </div>
            </div>
        </div>
        
        <div class="insights-grid">
            <div class="insight-card insight-card-eco">
                <div class="insight-card-header">
                    <div class="insight-card-icon">‚ú®</div>
                    <h3>Oportunidades de Eco</h3>
                </div>
                <div class="insight-card-body" id="card-eco"></div>
            </div>
            <div class="insight-card insight-card-multi">
                <div class="insight-card-header">
                    <div class="insight-card-icon">üîÄ</div>
                    <h3>Encaminhamentos</h3>
                </div>
                <div class="insight-card-body" id="card-multi"></div>
            </div>
            <div class="insight-card insight-card-risco">
                <div class="insight-card-header">
                    <div class="insight-card-icon">‚ö†Ô∏è</div>
                    <h3>Alerta de Risco</h3>
                </div>
                <div class="insight-card-body" id="card-risco"></div>
            </div>
        </div>
        
        <!-- Se√ß√£o de Jornadas de Encaminhamento -->
        <div class="diamond-section" style="margin-top: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border-color: rgba(59, 130, 246, 0.3);">
            <h2 class="diamond-title" style="color: #60a5fa;">üîÑ Fluxo de Encaminhamentos</h2>
            <p class="diamond-subtitle">Jornada dos pacientes entre especialidades</p>
            <div id="encaminhamentos-list" class="diamond-list"></div>
        </div>
        
        <div class="diamond-section">
            <h2 class="diamond-title">üíé Diamond Club</h2>
            <p class="diamond-subtitle">Pacientes VIP e Multidisciplinares</p>
            <div id="diamond-list" class="diamond-list"></div>
        </div>
        
        <div class="delta-section">
            <h2 class="delta-title">üìà Tend√™ncias de PA</h2>
            <p class="delta-subtitle">Evolu√ß√£o da press√£o arterial m√©dia</p>
            <div id="chart-container">
                <canvas id="pa-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
let supabaseClient = null;

function init() {
    if (typeof supabase === 'undefined' || !SUPABASE_CONFIG) {
        document.getElementById('loading').innerHTML = '‚ùå Erro ao carregar Supabase';
        return;
    }
    supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
    carregarDados();
}

async function carregarDados() {
    try {
        const { data, error } = await supabaseClient.from('triagens').select('*').order('data_triagem', { ascending: false });
        if (error) throw error;
        
        const pacientes = processarPacientes(data);
        renderizarInsights(pacientes);
        renderizarDiamond(pacientes);
        renderizarGrafico(pacientes);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
    } catch (e) {
        document.getElementById('loading').innerHTML = '‚ùå Erro: ' + e.message;
    }
}

function processarPacientes(data) {
    const pac = {};
    data.forEach(a => {
        const n = a.nome_paciente;
        if (!pac[n]) pac[n] = { 
            nome: n, 
            visitas: 0, 
            esp: new Set(), 
            pa: [], 
            eco: false,
            jornada: [], // Array completo de consultas com datas
            primeiraConsulta: null,
            ultimaConsulta: null
        };
        pac[n].visitas++;
        if (a.especialidade) pac[n].esp.add(a.especialidade);
        if (a.pressao_sis_esquerdo) pac[n].pa.push({ data: a.data_triagem, sis: a.pressao_sis_esquerdo, dia: a.pressao_dia_esquerdo });
        if (a.tipo_atendimento && a.tipo_atendimento.toLowerCase().includes('eco')) pac[n].eco = true;
        
        // Adicionar √† jornada completa
        pac[n].jornada.push({
            data: a.data_triagem,
            especialidade: a.especialidade || 'N/A',
            tipo: a.tipo_atendimento || 'N/A',
            pa: a.pressao_sis_esquerdo ? `${a.pressao_sis_esquerdo}x${a.pressao_dia_esquerdo}` : null
        });
    });
    
    // Processar jornada de cada paciente
    return Object.values(pac).map(p => {
        // Ordenar jornada por data (mais antiga primeiro)
        p.jornada.sort((a, b) => new Date(a.data) - new Date(b.data));
        
        // Identificar primeira e √∫ltima consulta
        if (p.jornada.length > 0) {
            p.primeiraConsulta = p.jornada[0];
            p.ultimaConsulta = p.jornada[p.jornada.length - 1];
            p.primeiraEspecialidade = p.jornada[0].especialidade;
            
            // Calcular sequ√™ncia de especialidades (fluxo de encaminhamento)
            p.fluxoEspecialidades = p.jornada.map(j => j.especialidade).filter((v, i, a) => a.indexOf(v) === i);
            
            // Calcular dias desde √∫ltima consulta
            const hoje = new Date();
            const ultimaData = new Date(p.ultimaConsulta.data);
            p.diasSemRetorno = Math.floor((hoje - ultimaData) / (1000 * 60 * 60 * 24));
            
            // Identificar se foi encaminhado (mudou de especialidade)
            p.foiEncaminhado = p.fluxoEspecialidades.length > 1;
            if (p.foiEncaminhado) {
                p.origemEncaminhamento = p.fluxoEspecialidades[0];
                p.destinoEncaminhamento = p.fluxoEspecialidades[p.fluxoEspecialidades.length - 1];
            }
        }
        
        return { ...p, esp: Array.from(p.esp) };
    });
}

function renderizarInsights(pacientes) {
    const eco = pacientes.filter(p => p.esp.includes('Cardiologia') && !p.eco);
    document.getElementById('card-eco').innerHTML = eco.length > 0 
        ? `<div style="font-size:28px;font-weight:700;color:#10b981;margin-bottom:8px">${eco.length}</div><p>Pacientes Cardio sem Eco</p>`
        : '‚úÖ Todos fizeram Eco!';
    
    // Encaminhamentos (pacientes multi-especialidade)
    const encaminhados = pacientes.filter(p => p.foiEncaminhado);
    document.getElementById('card-multi').innerHTML = encaminhados.length > 0
        ? `<div style="font-size:28px;font-weight:700;color:#3b82f6;margin-bottom:8px">${encaminhados.length}</div><p>Pacientes encaminhados</p>`
        : 'üìä Sem encaminhamentos registrados';
    
    const risco = pacientes.filter(p => p.pa.length > 0 && p.pa[0].sis >= 160);
    document.getElementById('card-risco').innerHTML = risco.length > 0
        ? `<div style="font-size:28px;font-weight:700;color:#ef4444;margin-bottom:8px">${risco.length}</div><p>PA elevada (‚â•160)</p>`
        : '‚úÖ Nenhum risco cr√≠tico';
    
    // Renderizar lista de encaminhamentos
    const listEncaminhamentos = document.getElementById('encaminhamentos-list');
    if (encaminhados.length > 0) {
        listEncaminhamentos.innerHTML = encaminhados.map(p => `
            <div class="diamond-item" style="border-color: rgba(59, 130, 246, 0.3);">
                <div class="diamond-item-name" style="color: #60a5fa;">üîÑ ${p.nome}</div>
                <div class="diamond-item-stats">
                    <strong>${p.fluxoEspecialidades ? p.fluxoEspecialidades.join(' ‚Üí ') : 'N/A'}</strong><br>
                    <small>${p.visitas} consultas ‚Ä¢ √öltima h√° ${p.diasSemRetorno || 0} dias</small>
                </div>
            </div>
        `).join('');
    } else {
        listEncaminhamentos.innerHTML = '<div style="text-align:center;padding:20px;color:#cbd5e1">Nenhum encaminhamento entre especialidades ainda.<br><small>Registre pacientes em m√∫ltiplas especialidades para rastrear o fluxo.</small></div>';
    }
}

function renderizarDiamond(pacientes) {
    const vip = pacientes.filter(p => p.visitas >= 3 || p.esp.length >= 2).sort((a,b) => b.visitas - a.visitas).slice(0, 8);
    const list = document.getElementById('diamond-list');
    if (vip.length > 0) {
        list.innerHTML = vip.map(p => `
            <div class="diamond-item">
                <div class="diamond-item-name">üíé ${p.nome}</div>
                <div class="diamond-item-stats">${p.visitas} visitas ‚Ä¢ ${p.esp.join(' + ')}</div>
            </div>
        `).join('');
    } else {
        list.innerHTML = '<div style="text-align:center;padding:20px;color:#cbd5e1">Nenhum VIP ainda</div>';
    }
}

function renderizarGrafico(pacientes) {
    const porMes = {};
    pacientes.forEach(p => p.pa.forEach(pa => {
        const mes = pa.data?.substring(0,7) || '';
        if (mes) {
            if (!porMes[mes]) porMes[mes] = { t: 0, c: 0 };
            porMes[mes].t += pa.sis;
            porMes[mes].c++;
        }
    }));
    const meses = Object.keys(porMes).sort();
    const medias = meses.map(m => (porMes[m].t / porMes[m].c).toFixed(1));
    
    if (meses.length > 0) {
        new Chart(document.getElementById('pa-chart'), {
            type: 'line',
            data: {
                labels: meses.map(m => m.split('-').reverse().join('/')),
                datasets: [{ label: 'PA Sist√≥lica M√©dia', data: medias, borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.1)', tension: 0.4, fill: true }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#e2e8f0' } } },
                scales: { y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.1)' } } }
            }
        });
    }
}

async function enviarPergunta() {
    const input = document.getElementById('chat-input');
    const pergunta = input.value.trim();
    if (!pergunta) return;
    
    const chat = document.getElementById('chat-messages');
    chat.innerHTML += `<div class="chat-message user"><div class="chat-bubble user">${pergunta}</div><div class="chat-avatar user">üë§</div></div>`;
    input.value = '';
    chat.innerHTML += `<div class="chat-message ai" id="ai-loading"><div class="chat-avatar ai">ü§ñ</div><div class="chat-bubble ai">Analisando...</div></div>`;
    chat.scrollTop = chat.scrollHeight;
    
    try {
        const { data } = await supabaseClient.from('triagens').select('*').order('data_triagem', { ascending: true });
        const pacientes = processarPacientes(data);
        
        // Preparar dados enriquecidos com jornada completa
        const dadosEnriquecidos = pacientes.slice(0, 50).map(p => ({
            nome: p.nome,
            visitas: p.visitas,
            especialidades: p.esp,
            primeiraEspecialidade: p.primeiraEspecialidade || 'N/A',
            fluxoEncaminhamento: p.fluxoEspecialidades ? p.fluxoEspecialidades.join(' ‚Üí ') : 'N/A',
            foiEncaminhado: p.foiEncaminhado || false,
            origemEncaminhamento: p.origemEncaminhamento || null,
            destinoEncaminhamento: p.destinoEncaminhamento || null,
            diasSemRetorno: p.diasSemRetorno || 0,
            fezEco: p.eco,
            ultimaPA: p.pa[0] ? `${p.pa[0].sis}x${p.pa[0].dia}` : 'N/A',
            jornada: p.jornada ? p.jornada.map(j => `${j.data}: ${j.especialidade} (${j.tipo})`).join(' | ') : 'N/A'
        }));
        
        // Estat√≠sticas de encaminhamento
        const encaminhados = pacientes.filter(p => p.foiEncaminhado);
        const endocrinoParaCardio = encaminhados.filter(p => 
            p.fluxoEspecialidades && 
            p.fluxoEspecialidades.includes('Endocrinologia') && 
            p.fluxoEspecialidades.indexOf('Cardiologia') > p.fluxoEspecialidades.indexOf('Endocrinologia')
        );
        
        const resp = await fetch('/.netlify/functions/ia-estrategica', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                pergunta,
                dadosCompletos: {
                    totalPacientes: pacientes.length,
                    totalAtendimentos: data.length,
                    totalEncaminhados: encaminhados.length,
                    encaminhamentosEndocrinoCardio: endocrinoParaCardio.length,
                    pacientes: dadosEnriquecidos
                }
            })
        });
        const result = await resp.json();
        document.getElementById('ai-loading')?.remove();
        chat.innerHTML += `<div class="chat-message ai"><div class="chat-avatar ai">ü§ñ</div><div class="chat-bubble ai">${result.resposta || 'Erro ao processar'}</div></div>`;
    } catch (e) {
        document.getElementById('ai-loading')?.remove();
        chat.innerHTML += `<div class="chat-message ai"><div class="chat-avatar ai">ü§ñ</div><div class="chat-bubble ai">‚ùå Erro: ${e.message}</div></div>`;
    }
    chat.scrollTop = chat.scrollHeight;
}

document.getElementById('chat-input')?.addEventListener('keypress', e => { if (e.key === 'Enter') enviarPergunta(); });
window.onload = init;
</script>

</body>
</html>

