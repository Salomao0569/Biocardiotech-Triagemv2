<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Intelig√™ncia IA - Cl√≠nica Biocardio</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            min-height: 100vh;
        }
        
        /* CABE√áALHO */
        .header {
            background: linear-gradient(135deg, #003d7a 0%, #002850 100%);
            color: white;
            padding: 30px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .clinica { color: #fff; }
        .biocardio { color: #c8102e; }
        
        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .header-nav {
            display: flex;
            gap: 15px;
        }
        
        .btn-nav {
            padding: 12px 24px;
            border: 2px solid white;
            background: transparent;
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-nav:hover {
            background: white;
            color: #003d7a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.3);
        }
        
        /* CONTAINER */
        .container {
            max-width: 1600px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .page-title {
            font-family: 'Montserrat', sans-serif;
            color: #60a5fa;
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 10px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .page-subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 40px;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #60a5fa;
            font-size: 20px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ORACLE IA */
        .oracle-section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .oracle-title {
            color: #60a5fa;
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .oracle-subtitle {
            color: #94a3b8;
            margin-bottom: 20px;
        }
        
        .oracle-chat {
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-messages {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        .chat-welcome {
            text-align: center;
            padding: 40px 20px;
        }
        
        .welcome-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .chat-welcome h3 {
            color: #60a5fa;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .chat-welcome p {
            color: #94a3b8;
            margin-bottom: 20px;
        }
        
        .example-questions {
            list-style: none;
            text-align: left;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .example-questions li {
            background: rgba(96, 165, 250, 0.1);
            padding: 12px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: #cbd5e1;
            border-left: 3px solid #60a5fa;
        }
        
        .chat-message {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-message.user {
            flex-direction: row-reverse;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .chat-avatar.user {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .chat-avatar.ai {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
        }
        
        .chat-bubble {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        
        .chat-bubble.user {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        
        .chat-bubble.ai {
            background: rgba(255,255,255,0.05);
            color: #e2e8f0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(255,255,255,0.08);
        }
        
        .btn-send-chat {
            padding: 15px 30px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-send-chat:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        /* GRID DE INSIGHTS */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .insight-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        
        .insight-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.2);
        }
        
        .insight-card-eco {
            border-left: 4px solid #10b981;
        }
        
        .insight-card-multi {
            border-left: 4px solid #8b5cf6;
        }
        
        .insight-card-risco {
            border-left: 4px solid #ef4444;
        }
        
        .insight-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .insight-card-icon {
            font-size: 32px;
        }
        
        .insight-card-header h3 {
            color: #e2e8f0;
            font-size: 18px;
            font-weight: 700;
        }
        
        .insight-card-body {
            color: #cbd5e1;
            line-height: 1.6;
        }
        
        .loading-small {
            text-align: center;
            padding: 20px;
            color: #60a5fa;
            font-style: italic;
            animation: pulse 2s infinite;
        }
        
        /* DIAMOND CLUB */
        .diamond-club-section {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.1));
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        
        .diamond-title {
            color: #c084fc;
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .diamond-subtitle {
            color: #cbd5e1;
            margin-bottom: 20px;
        }
        
        .diamond-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .diamond-item {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            transition: all 0.3s;
        }
        
        .diamond-item:hover {
            transform: scale(1.02);
            border-color: #c084fc;
        }
        
        .diamond-item-name {
            color: white;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .diamond-item-stats {
            color: #cbd5e1;
            font-size: 14px;
        }
        
        /* DELTA VITALS */
        .delta-vitals-section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .delta-title {
            color: #60a5fa;
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .delta-subtitle {
            color: #cbd5e1;
            margin-bottom: 20px;
        }
        
        #delta-vitals-chart-container {
            background: rgba(255,255,255,0.03);
            padding: 20px;
            border-radius: 12px;
            min-height: 400px;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-content">
        <div>
            <div class="logo">
                <span class="clinica">CL√çNICA</span> <span class="biocardio">Biocardio</span>
            </div>
            <div class="header-subtitle">üß† Central de Intelig√™ncia IA</div>
        </div>
        <div class="header-nav">
            <a href="index.html" class="btn-nav">üìã Nova Triagem</a>
            <a href="dashboard.html" class="btn-nav">üìä Dashboard</a>
            <button class="btn-nav" onclick="location.reload()">üîÑ Atualizar</button>
        </div>
    </div>
</div>

<div class="container">
    <h1 class="page-title">üß† Biocardio Intelligence Hub</h1>
    <p class="page-subtitle">Gest√£o Estrat√©gica e Cl√≠nica de Precis√£o</p>
    
    <div id="loading-ia" class="loading">üîÆ Analisando hist√≥rico de exames...</div>
    
    <div id="central-ia-content" style="display: none;">
        
        <!-- CHAT INTERATIVO (ORACLE IA) -->
        <div class="oracle-section">
            <h2 class="oracle-title">üí¨ Oracle IA - Consulta Inteligente</h2>
            <p class="oracle-subtitle">Fa√ßa perguntas sobre seus dados e receba insights estrat√©gicos</p>
            
            <div class="oracle-chat">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-welcome">
                        <div class="welcome-icon">üîÆ</div>
                        <h3>Bem-vindo √† Central de Intelig√™ncia Biocardio</h3>
                        <p>Pergunte qualquer coisa sobre seus pacientes:</p>
                        <ul class="example-questions">
                            <li>"Quem s√£o os hipertensos que n√£o fazem Eco h√° 6 meses?"</li>
                            <li>"Qual a m√©dia de PA dos pacientes de Cardiologia?"</li>
                            <li>"Quais pacientes precisam de retorno urgente?"</li>
                        </ul>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Digite sua pergunta sobre os dados..." class="chat-input">
                    <button onclick="enviarPerguntaIA()" class="btn-send-chat">üöÄ Enviar</button>
                </div>
            </div>
        </div>
        
        <!-- GRID DE INSIGHTS PROATIVOS -->
        <div class="insights-grid">
            <!-- CARD 1: OPORTUNIDADES DE ECOCARDIOGRAMA -->
            <div class="insight-card insight-card-eco">
                <div class="insight-card-header">
                    <div class="insight-card-icon">‚ú®</div>
                    <h3>Oportunidades de Ecocardiograma</h3>
                </div>
                <div class="insight-card-body" id="card-eco-oportunidades">
                    <div class="loading-small">Calculando oportunidades...</div>
                </div>
            </div>
            
            <!-- CARD 2: SINERGIA MULTIDISCIPLINAR -->
            <div class="insight-card insight-card-multi">
                <div class="insight-card-header">
                    <div class="insight-card-icon">üîÄ</div>
                    <h3>Sinergia Multidisciplinar</h3>
                </div>
                <div class="insight-card-body" id="card-sinergia">
                    <div class="loading-small">Calculando sinergia...</div>
                </div>
            </div>
            
            <!-- CARD 3: ALERTA DE RISCO CL√çNICO -->
            <div class="insight-card insight-card-risco">
                <div class="insight-card-header">
                    <div class="insight-card-icon">‚ö†Ô∏è</div>
                    <h3>Alerta de Risco Cl√≠nico</h3>
                </div>
                <div class="insight-card-body" id="card-risco">
                    <div class="loading-small">Identificando riscos...</div>
                </div>
            </div>
        </div>
        
        <!-- RANKING DE FIDELIDADE (DIAMOND CLUB) -->
        <div class="diamond-club-section">
            <h2 class="diamond-title">üíé Diamond Club - Pacientes VIP</h2>
            <p class="diamond-subtitle">Identifica√ß√£o autom√°tica de pacientes fi√©is e multidisciplinares</p>
            <div id="diamond-club-list" class="diamond-list"></div>
        </div>
        
        <!-- AN√ÅLISE DE TEND√äNCIAS (DELTA VITALS) -->
        <div class="delta-vitals-section">
            <h2 class="delta-title">üìà Delta Vitals - Tend√™ncias Cl√≠nicas</h2>
            <p class="delta-subtitle">Relat√≥rio autom√°tico de melhoria ou piora dos pacientes da cl√≠nica</p>
            <div id="delta-vitals-chart-container">
                <canvas id="delta-vitals-chart"></canvas>
            </div>
        </div>
        
    </div>
</div>

<script>
    // Vari√°vel global
    let supabaseClient = null;
    
    // Inicializar Supabase
    function inicializarSupabase() {
        if (typeof supabase === 'undefined') {
            alert('‚ùå Supabase SDK n√£o carregado!');
            return false;
        }
        
        if (!SUPABASE_CONFIG || !SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey) {
            alert('‚ùå Configure o arquivo supabase-config.js!');
            return false;
        }
        
        try {
            supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
            return true;
        } catch (error) {
            console.error('Erro ao inicializar Supabase:', error);
            return false;
        }
    }
    
    // Carregar Central IA
    async function carregarCentralIA() {
        const loadingIA = document.getElementById('loading-ia');
        const contentIA = document.getElementById('central-ia-content');
        
        if (!inicializarSupabase()) {
            loadingIA.innerHTML = '‚ùå Erro ao conectar ao Supabase';
            return;
        }
        
        try {
            // Buscar TODOS os dados do Supabase
            const { data: allData, error } = await supabaseClient
                .from('triagens')
                .select('*')
                .order('data_triagem', { ascending: false });
            
            if (error) throw error;
            
            // Processar dados para an√°lise
            const dadosProcessados = processarDadosEstrategicos(allData);
            
            // Gerar Insights Proativos
            await gerarInsightsProativos(dadosProcessados);
            
            // Gerar Diamond Club
            gerarDiamondClub(dadosProcessados);
            
            // Gerar Delta Vitals
            gerarDeltaVitals(dadosProcessados);
            
            loadingIA.style.display = 'none';
            contentIA.style.display = 'block';
            
        } catch (error) {
            console.error('Erro ao carregar Central IA:', error);
            loadingIA.innerHTML = '‚ùå Erro ao carregar dados. Tente novamente.';
        }
    }
    
    // Processar dados estrat√©gicos
    function processarDadosEstrategicos(allData) {
        // Agrupar por paciente
        const pacientes = {};
        
        allData.forEach(atend => {
            const nome = atend.nome_paciente;
            if (!pacientes[nome]) {
                pacientes[nome] = {
                    nome: nome,
                    totalVisitas: 0,
                    especialidades: new Set(),
                    ultimaVisita: null,
                    primeiraVisita: null,
                    historicosPA: [],
                    fezEco: false,
                    ultimoEco: null
                };
            }
            
            pacientes[nome].totalVisitas++;
            if (atend.especialidade) pacientes[nome].especialidades.add(atend.especialidade);
            if (!pacientes[nome].ultimaVisita || atend.data_triagem > pacientes[nome].ultimaVisita) {
                pacientes[nome].ultimaVisita = atend.data_triagem;
            }
            if (!pacientes[nome].primeiraVisita || atend.data_triagem < pacientes[nome].primeiraVisita) {
                pacientes[nome].primeiraVisita = atend.data_triagem;
            }
            if (atend.pressao_sis_esquerdo) {
                pacientes[nome].historicosPA.push({
                    data: atend.data_triagem,
                    sis: atend.pressao_sis_esquerdo,
                    dia: atend.pressao_dia_esquerdo
                });
            }
            if (atend.tipo_atendimento && atend.tipo_atendimento.toLowerCase().includes('ecocardiograma')) {
                pacientes[nome].fezEco = true;
                pacientes[nome].ultimoEco = atend.data_triagem;
            }
        });
        
        // Converter para array
        const pacientesArray = Object.values(pacientes).map(p => ({
            ...p,
            especialidades: Array.from(p.especialidades),
            diasDesdeUltimaVisita: calcularDiasAte(p.ultimaVisita)
        }));
        
        return {
            totalPacientes: pacientesArray.length,
            totalAtendimentos: allData.length,
            pacientes: pacientesArray,
            especialidades: [...new Set(allData.map(a => a.especialidade).filter(e => e))]
        };
    }
    
    // Calcular dias at√© hoje
    function calcularDiasAte(data) {
        if (!data) return null;
        const hoje = new Date();
        const dataObj = new Date(data);
        const diff = Math.floor((hoje - dataObj) / (1000 * 60 * 60 * 24));
        return diff;
    }
    
    // Gerar Insights Proativos
    async function gerarInsightsProativos(dados) {
        // CARD 1: Oportunidades de Ecocardiograma
        const cardEco = document.getElementById('card-eco-oportunidades');
        const oportunidadesEco = dados.pacientes.filter(p => 
            p.especialidades.includes('Cardiologia') && !p.fezEco
        );
        
        if (oportunidadesEco.length > 0) {
            cardEco.innerHTML = `
                <div style="font-size: 32px; font-weight: 700; color: #10b981; margin-bottom: 10px;">
                    ${oportunidadesEco.length}
                </div>
                <p style="margin-bottom: 15px;">Pacientes de Cardiologia sem Ecocardiograma registrado</p>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${oportunidadesEco.slice(0, 5).map(p => `
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 3px solid #10b981;">
                            <strong>${p.nome}</strong> - ${p.totalVisitas} ${p.totalVisitas === 1 ? 'visita' : 'visitas'}
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            cardEco.innerHTML = '<div style="text-align: center; padding: 20px;">‚úÖ Todos os pacientes card√≠acos j√° realizaram Ecocardiograma!</div>';
        }
        
        // CARD 2: Sinergia Multidisciplinar
        const cardSinergia = document.getElementById('card-sinergia');
        const multidisciplinares = dados.pacientes.filter(p => p.especialidades.length > 1);
        
        if (multidisciplinares.length > 0) {
            cardSinergia.innerHTML = `
                <div style="font-size: 32px; font-weight: 700; color: #8b5cf6; margin-bottom: 10px;">
                    ${multidisciplinares.length}
                </div>
                <p style="margin-bottom: 15px;">Pacientes em tratamento integrado (2+ especialidades)</p>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${multidisciplinares.slice(0, 5).map(p => `
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 3px solid #8b5cf6;">
                            <strong>${p.nome}</strong><br>
                            <small>${p.especialidades.join(' + ')}</small>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            cardSinergia.innerHTML = '<div style="text-align: center; padding: 20px;">üìä Todos os pacientes est√£o em especialidade √∫nica</div>';
        }
        
        // CARD 3: Alerta de Risco Cl√≠nico
        const cardRisco = document.getElementById('card-risco');
        const pacientesRisco = dados.pacientes.filter(p => {
            const ultimaPA = p.historicosPA.length > 0 ? p.historicosPA[0] : null;
            return ultimaPA && ultimaPA.sis >= 160 && p.diasDesdeUltimaVisita > 90;
        });
        
        if (pacientesRisco.length > 0) {
            cardRisco.innerHTML = `
                <div style="font-size: 32px; font-weight: 700; color: #ef4444; margin-bottom: 10px;">
                    ${pacientesRisco.length}
                </div>
                <p style="margin-bottom: 15px;">Pacientes hipertensos (PA > 160/100) sem retorno h√° 3+ meses</p>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${pacientesRisco.slice(0, 5).map(p => {
                        const ultimaPA = p.historicosPA[0];
                        return `
                            <div style="background: rgba(239, 68, 68, 0.1); padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 3px solid #ef4444;">
                                <strong>${p.nome}</strong><br>
                                <small>PA: ${ultimaPA.sis}√ó${ultimaPA.dia} mmHg ‚Ä¢ ${p.diasDesdeUltimaVisita} dias</small>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            cardRisco.innerHTML = '<div style="text-align: center; padding: 20px;">‚úÖ Nenhum paciente de alto risco identificado!</div>';
        }
    }
    
    // Gerar Diamond Club
    function gerarDiamondClub(dados) {
        const diamondList = document.getElementById('diamond-club-list');
        
        // Pacientes Diamante: 5+ visitas E 2+ especialidades
        const diamantes = dados.pacientes
            .filter(p => p.totalVisitas >= 5 || p.especialidades.length >= 2)
            .sort((a, b) => b.totalVisitas - a.totalVisitas)
            .slice(0, 10);
        
        if (diamantes.length > 0) {
            diamondList.innerHTML = diamantes.map(p => `
                <div class="diamond-item">
                    <div class="diamond-item-name">üíé ${p.nome}</div>
                    <div class="diamond-item-stats">
                        ${p.totalVisitas} ${p.totalVisitas === 1 ? 'visita' : 'visitas'} ‚Ä¢ ${p.especialidades.join(' + ')}
                        ${p.especialidades.length > 1 ? ' ‚Ä¢ üîÄ Multidisciplinar' : ''}
                    </div>
                </div>
            `).join('');
        } else {
            diamondList.innerHTML = '<div style="text-align: center; padding: 20px; color: #cbd5e1;">Nenhum paciente VIP identificado ainda</div>';
        }
    }
    
    // Gerar Delta Vitals (Tend√™ncias)
    function gerarDeltaVitals(dados) {
        // Calcular m√©dia de PA por m√™s
        const pasPorMes = {};
        dados.pacientes.forEach(p => {
            p.historicosPA.forEach(pa => {
                const mes = pa.data.substring(0, 7); // YYYY-MM
                if (!pasPorMes[mes]) pasPorMes[mes] = { total: 0, count: 0 };
                pasPorMes[mes].total += pa.sis;
                pasPorMes[mes].count++;
            });
        });
        
        const meses = Object.keys(pasPorMes).sort();
        const medias = meses.map(mes => (pasPorMes[mes].total / pasPorMes[mes].count).toFixed(1));
        
        // Criar gr√°fico
        const ctx = document.getElementById('delta-vitals-chart');
        if (ctx && meses.length > 0) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses.map(m => {
                        const [ano, mes] = m.split('-');
                        return `${mes}/${ano}`;
                    }),
                    datasets: [{
                        label: 'Press√£o Arterial Sist√≥lica M√©dia',
                        data: medias,
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#cbd5e1' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#cbd5e1' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        } else {
            document.getElementById('delta-vitals-chart-container').innerHTML = '<div style="text-align: center; padding: 40px; color: #cbd5e1;">Dados insuficientes para gerar gr√°fico de tend√™ncias</div>';
        }
    }
    
    // Enviar pergunta para Oracle IA
    async function enviarPerguntaIA() {
        const input = document.getElementById('chat-input');
        const pergunta = input.value.trim();
        
        if (!pergunta) {
            alert('Por favor, digite uma pergunta');
            return;
        }
        
        const chatMessages = document.getElementById('chat-messages');
        
        // Adicionar mensagem do usu√°rio
        const userMsg = document.createElement('div');
        userMsg.className = 'chat-message user';
        userMsg.innerHTML = `
            <div class="chat-bubble user">${pergunta}</div>
            <div class="chat-avatar user">üë§</div>
        `;
        chatMessages.appendChild(userMsg);
        
        // Limpar input
        input.value = '';
        
        // Adicionar mensagem de loading da IA
        const aiLoadingMsg = document.createElement('div');
        aiLoadingMsg.className = 'chat-message ai';
        aiLoadingMsg.innerHTML = `
            <div class="chat-avatar ai">ü§ñ</div>
            <div class="chat-bubble ai">Analisando dados...</div>
        `;
        chatMessages.appendChild(aiLoadingMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        try {
            // Buscar dados completos
            const { data: allData, error } = await supabaseClient
                .from('triagens')
                .select('*');
            
            if (error) throw error;
            
            const dadosProcessados = processarDadosEstrategicos(allData);
            
            // Enviar para Netlify Function
            const response = await fetch('/.netlify/functions/ia-estrategica', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pergunta: pergunta,
                    dadosCompletos: {
                        totalPacientes: dadosProcessados.totalPacientes,
                        totalAtendimentos: dadosProcessados.totalAtendimentos,
                        especialidades: dadosProcessados.especialidades,
                        pacientes: dadosProcessados.pacientes.slice(0, 50).map(p => ({
                            nome: p.nome,
                            totalVisitas: p.totalVisitas,
                            especialidades: p.especialidades,
                            ultimaPA: p.historicosPA[0] ? `${p.historicosPA[0].sis}√ó${p.historicosPA[0].dia}` : null,
                            ultimoEco: p.ultimoEco
                        }))
                    }
                })
            });
            
            const data = await response.json();
            
            // Remover loading
            aiLoadingMsg.remove();
            
            // Adicionar resposta da IA
            const aiMsg = document.createElement('div');
            aiMsg.className = 'chat-message ai';
            aiMsg.innerHTML = `
                <div class="chat-avatar ai">ü§ñ</div>
                <div class="chat-bubble ai">${data.resposta || 'N√£o foi poss√≠vel gerar resposta.'}</div>
            `;
            chatMessages.appendChild(aiMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
        } catch (error) {
            console.error('Erro ao consultar Oracle IA:', error);
            aiLoadingMsg.remove();
            const errorMsg = document.createElement('div');
            errorMsg.className = 'chat-message ai';
            errorMsg.innerHTML = `
                <div class="chat-avatar ai">ü§ñ</div>
                <div class="chat-bubble ai">‚ùå Erro ao processar pergunta. Tente novamente.</div>
            `;
            chatMessages.appendChild(errorMsg);
        }
    }
    
    // Permitir Enter para enviar
    document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    enviarPerguntaIA();
                }
            });
        }
        
        // Carregar automaticamente
        carregarCentralIA();
    });
</script>

</body>
</html>

